/*
* author: Lin Xiao Dong <1071322670@qq.com>
* update: 2019.03.29
* website: http://www.openwbs.com/
*/
var OWFileManage,OWFileManage_Class=function($,window){var FILEMANAGE=function(a){var c,b=FILEMANAGE.defaults;a=a||{},("string"==typeof a||1===a.nodeType)&&(a={content:a});for(c in b)void 0===a[c]&&(a[c]=b[c]);return new FILEMANAGE.fn.constructor(a)};FILEMANAGE.fn=FILEMANAGE.prototype={constructor:function(a){var b;return this.config=a,this.dom=b=this.dom||this.init(a),this},init:function(a){var b={};return b.folderTree=$("#"+a.folderTreeID),b.fileContainer=$("#"+a.fileContainerID),b.dirPath=$("#"+a.dirPathID),b.menuLine=$("#"+a.menuLineID),b.operationTip=$("#"+a.operationTipID),b.fileList=$("#"+a.fileListID),b.filePages=$("#"+a.filePagesID),b.listType=$("#"+a.listTypeID),b},ajaxGetTreeFoldersData:function(a){var b=this,c=OWDialog({shadow:!1}),d=a.folderpath,e="index.asp?ctl="+b.config.ctl+"&act=list&subact=folderlist&folderpath="+escape(d)+b.config.auxUrlPara,f="";return Admin.ajax({me:"",async:!1,url:e,data:"",success:function(){f=Admin.ajaxData.folderJson[0],c.close()},failed:function(a){c.error("加载失败",a).button({id:"cancel",okVal:"关闭",focus:!0}).timeout(2)}}),f},ajaxGetFolderAndFilesData:function(a){var b=this,c=OWDialog({shadow:!1}),d=a.folderpath,e="index.asp?ctl="+b.config.ctl+"&act=list&subact=folderlist_and_filelist&folderpath="+escape(d)+b.config.auxUrlPara,f="";return Admin.ajax({me:"",async:!1,url:e,data:"",success:function(){f=Admin.ajaxData.folderJson,c.close()},failed:function(a){c.error("加载失败",a).button({id:"cancel",okVal:"关闭",focus:!0}).timeout(2)}}),f},treeFoldersAppend:function(a){var h,b=this,c=this.dom.folderTree,d=a.treeInit||!1,e=a.jsonData,f=a.subfolder,g="";for(d&&(c.append('<div class="folder open" folderpath="'+e.folderpath+'" subfolderscount="'+e.subfolderscount+'"><a href="javascript:;" class="node"></a><a href="javascript:;" class="foldername"><em></em><i>'+e.foldername+"</i></a></div>"),c.append('<div class="subfolders"></div>'),f=c.find("div.subfolders")),f.html(""),h=0;h<e.subfolders.length;h++)g=g+'<div class="folder" folderpath="'+e.subfolders[h].folderpath+'" subfolderscount="'+e.subfolders[h].subfolderscount+'"><a href="javascript:;" class="node"></a><a href="javascript:;" class="foldername"><em></em><i>'+e.subfolders[h].foldername+"</i></a></div>";f.append(g),f.find(".folder").each(function(){0==parseInt($(this).attr("subfolderscount"))?$(this).find(".node").addClass("single"):$(this).after('<div class="subfolders"></div>')}),c.find(".node").unbind("click").click(function(){b.treeSubFoldersOpen({folder:$(this).parent()})}),c.find(".foldername").unbind("click").click(function(){var a=b.ajaxGetFolderAndFilesData({folderpath:$(this).parent().attr("folderpath")});b.treeSubFoldersOpen({folder:$(this).parent(),jsonData:a[0]}),b.folderAndFilesAppend({jsonData:a})})},treeSubFoldersOpen:function(a){var b=this,c=a.folder,d=a.jsonData;0==c.next(".subfolders").find(".folder").length&&(c.find(".node").addClass("loading"),(""==d||void 0==d)&&(d=b.ajaxGetTreeFoldersData({folderpath:c.attr("folderpath")})),b.treeFoldersAppend({treeInit:!1,jsonData:d,subfolder:c.next(".subfolders")}),c.find(".node").removeClass("loading")),c.attr("class").indexOf("open")>0?(c.removeClass("open"),c.next(".subfolders").hide("fast")):(c.addClass("open"),c.next(".subfolders").show("fast"))},treeSubFoldersReload:function(a){var b=this,c=a.folder,d=a.jsonData;0==c.attr("subfolderscount")?d.subfolders.length>0&&(c.find(".node").removeClass("single"),c.after('<div class="subfolders"></div>')):c.next(".subfolders").html(""),c.attr("subfolderscount",d.subfolders.length),b.treeSubFoldersOpen({folder:c,jsonData:d})},treeFolderRemove:function(a){var b=this.dom.folderTree,c=b.find(".folder[folderpath='"+a+"']"),d=c.parent();d.prev(".folder").attr("subfolderscount",d.prev(".folder").attr("subfolderscount")-1),0==c.siblings().length&&(d.prev(".folder").find(".node").addClass("single").unbind("click"),d.next(".subfolders").remove(),d.remove()),c.next(".subfolders").remove(),c.remove()},folderAndFilesAppend:function(opt){var dt,html,foldersHTML,filesHTML,i,$tFolder,This=this,error=!1,json=opt.jsonData,listType=opt.listtype||OW.cookie.getCookie("filelisttype")||This.config.listType||"list",$folderTree=this.dom.folderTree,$fileContainer=this.dom.fileContainer,$menuLine=this.dom.menuLine,$fileList=this.dom.fileList;try{Admin.OWRuntime(json[2].runtime).SQLQueryNum(json[2].sqlquerynum)}catch(e){json=OW.JSON.parse('[{},{},{"runtime":"0.0","sqlquerynum":"0"}]'),error=!0}if(!error){for($fileList.html(""),eval(this.config.folderAndFilesAppendCallBack),dt='<dt><div class="checkbox"><input type="checkbox" name="selectall" value="" title="全选" /></div><div class="name">名称</div><div class="datetime">日期</div><div class="size">大小</div></dt>',foldersHTML="",i=0;i<json[0].subfolders.length;i++)foldersHTML=foldersHTML+'<dd class="folder" folderpath="'+json[0].subfolders[i].folderpath+'">'+'<div class="checkbox"><input type="checkbox" name="folder" value="'+json[0].subfolders[i].folderpath+'" title="选择" /></div>'+'<div class="preview"></div>'+'<div class="name"><span class="icons_file icon_folder"></span><a href="javascript:;" title="'+json[0].subfolders[i].folderpath+'">'+json[0].subfolders[i].foldername+"</a></div>"+'<div class="datetime">'+json[0].subfolders[i].datetime+"</div>"+'<div class="size">'+json[0].subfolders[i].size+"</div>"+"</dd>";for(filesHTML="",i=0;i<json[1].files.length;i++)filesHTML=filesHTML+'<dd class="file" filepath="'+json[1].files[i].filepath+'">'+'<div class="checkbox"><input type="checkbox" name="file" value="'+json[1].files[i].filepath+'" title="选择" /></div>'+'<div class="preview"></div>'+'<div class="name"><span class="icons_file icon_file icon_file_'+OW.fileExName(json[1].files[i].filepath)+'"></span><a href="javascript:;" title="'+json[1].files[i].filename+'">'+json[1].files[i].filename+"</a></div>"+'<div class="datetime">'+json[1].files[i].datetime+"</div>"+'<div class="size">'+json[1].files[i].size+"</div>"+"</dd>";"thumb"==listType?($fileList.append('<dl class="thumb">'+dt+foldersHTML+filesHTML+"</dl>"),$fileList.find("dd.folder>.name>a").unbind("click")):$fileList.append('<dl class="list">'+dt+foldersHTML+filesHTML+"</dl>"),This.foldersAndfilesPreview(listType),This.dirPath(json[0].folderpath),$tFolder=$folderTree.find("div[folderpath='"+json[0].folderpath+"']"),0==$tFolder.next(".subfolders").find(".folder").length?This.treeSubFoldersOpen({folder:$tFolder,jsonData:json[0]}):"none"==$tFolder.next(".subfolders").css("display")&&$tFolder.next(".subfolders").show("fast"),$folderTree.find(".single").parent(".folder").removeClass("open"),$folderTree.find(".folder").removeClass("current"),$tFolder.addClass("current"),$tFolder.addClass("open"),$tFolder.next(".subfolders").show("fast"),0==json[0].subfolders.length+json[1].files.length?$fileList.html('<div class="none">该文件夹为空</div>'):$fileContainer.find("#selectall-box").html('<label class="pr5"><input type="checkbox" name="selectall" value="" title="全选" />全选</label>'),$fileList.find("dd").click(function(){var a=$(this).find("input:checkbox");1==a.attr("checked")?(a.attr("checked",!1),$(this).removeClass("selected").attr("selected","false")):(a.attr("checked",!0),$(this).addClass("selected").attr("selected","selected"))}),$fileList.find("dd.folder>.name>a").click(function(){This.folderAndFilesAppend({jsonData:This.ajaxGetFolderAndFilesData({folderpath:$(this).parent(".name").parent(".folder").attr("folderpath")})})}),$fileList.find("dd.folder").dblclick(function(){This.folderAndFilesAppend({jsonData:This.ajaxGetFolderAndFilesData({folderpath:$(this).attr("folderpath")})})}),$fileList.find("dd.file>.name>a").click(function(){This.fileRename({me:$(this).parent(".name").parent(".file")})}),$fileList.find("dd.file").dblclick(function(){This.fileView({me:$(this)})}),$fileContainer.find("input[name='selectall']").unbind("click").click(function(){1==$(this).attr("checked")?($fileList.find("dd input:checkbox").attr("checked",!0),$fileList.find("dd").addClass("selected").attr("selected","selected")):($fileList.find("dd input:checkbox").attr("checked",!1),$fileList.find("dd").removeClass("selected").attr("selected","false"))})}},folderAndFilesReload:function(a){var b=this,c=this.dom.folderTree,d=a.folderpath,e=b.ajaxGetFolderAndFilesData({folderpath:d});b.treeSubFoldersReload({folder:c.find(".folder[folderpath='"+d+"']"),jsonData:e[0]}),b.folderAndFilesAppend({jsonData:e})},foldersAndfilesPreview:function(a){var b=this;"thumb"==a?(this.dom.fileContainer.find("#selectall-box").show("fast"),b.foldersPreview(),b.filesPreview()):this.dom.fileContainer.find("#selectall-box").hide("fast")},foldersPreview:function(){this.dom.fileList.find(".folder>.preview").each(function(){$(this).html('<span class="'+$(this).next().find("span").attr("class")+'"></span>')})},filesPreview:function(){this.dom.fileList.find(".file>.preview").each(function(){var a=$(this).parent(".file").attr("filepath");OW.isImage(a)?$(this).html('<img src="../'+a+"?r="+OW.random()+'" />'):$(this).html('<span class="'+$(this).next().find("span").attr("class")+'"></span>')})},fileView:function(a){var b=a.me,c=b.attr("filepath");OW.isImage(c)&&window.open("../"+c)},dirPath:function(a){var h,b=this,c=a.split("/"),d="",e="",f="",g=this.dom.dirPath;for(g.attr("folderpath",a),h=0;h<c.length;h++)""!=c[h]&&(d=d+c[h]+"/",h>0&&(f=f+'<span class="folder"><a href="javascript:;" folderpath="'+d+'">'+c[h]+'</a></span><span class="raquo">/</span>'));e='<span class="folderroot"><em></em>目录</span><span class="raquo">/</span>'+f,g.html(e),g.find(".folder>a").click(function(){b.folderAndFilesAppend({jsonData:b.ajaxGetFolderAndFilesData({folderpath:$(this).attr("folderpath")})})})},listType:function(a){var f,b=this,c=a.def||OW.cookie.getCookie("filelisttype")||b.config.listType||"",d=this.dom.fileList,e=this.dom.listType;("list"==c||"thumb"==c)&&OW.cookie.setCookie("filelisttype",c),f=OW.cookie.getCookie("filelisttype"),(""==f||void 0==f)&&(f=b.config.listType),e.find("li").each(function(){$(this).attr("listtype")==f?$(this).attr("class","current"):$(this).removeClass("current")}).click(function(){var a=$(this).attr("listtype");b.config.listType=a,OW.cookie.setCookie("filelisttype",a),e.find("li").removeClass("current"),$(this).addClass("current"),d.find("dl").attr("class",a),b.foldersAndfilesPreview(a)})},uploadFile:function(a){var b=a.upload_area;b.hide(50).show(50)},createNewFolder:function(){var a=this,b=OWDialog({id:OW.createDialogID(),title:"新建文件夹",content:FILEMANAGE.createFolderTpl,padding:"0px",ok:function(){var c=$("input[name='new_folder_name']"),d=$.trim(c.val()),e=a.dom.dirPath.attr("folderpath"),f=!0;return V.input({me:c,tip:$("span[name='t_new_folder_name']"),errorValue:"请先填写文件夹名称！"})||(f=!1),f&&(b.content('<div class="loading">正在提交保存，请稍候...</div>').padding("20px").button({id:"ok",remove:!0},{id:"cancel",disabled:!0}),Admin.ajax({me:"",async:!1,url:"index.asp?ctl="+a.config.ctl+"&act=add_createfolder"+a.config.auxUrlPara,data:"foldername="+escape(d)+"&folderpath="+e,success:function(){b.title(!1).success("成功新建文件夹").button({id:"cancel",remove:!0}).shadow(!1).timeout(2),a.folderAndFilesReload({folderpath:e})},failed:function(){b.close()}})),!1},cancel:!0,close:!1})},del:function(a){var b=this,c=this.dom.fileList,d=a.me,f=0,g="",h="";d.attr("disabled",!0),c.find("input[name='folder']").each(function(){1==$(this).attr("checked")&&(f++,g=""==g?'{"folderpath":"'+escape($(this).val())+'"}':g+',{"folderpath":"'+escape($(this).val())+'"}')}),c.find("input[name='file']").each(function(){1==$(this).attr("checked")&&(f++,h=""==h?'{"filepath":"'+escape($(this).val())+'"}':h+',{"filepath":"'+escape($(this).val())+'"}')}),0==f?OWDialog({content:"请选择您要删除的文件夹和文件!",ok:!0,follow:d,shadow:!1,timeout:2}):OWDialog({content:"删除后文件夹和文件将无法恢复，您确定要删除吗？",ok:function(){return b.deleting({dialog:this,data:'jsondata={"folders":['+g+'],"files":['+h+"]}",url:"index.asp?ctl="+b.config.ctl+"&act=delete"+b.config.auxUrlPara}),!1},cancel:!0,follow:d,close:!1}),d.attr("disabled",!1)},deleting:function(a){var d,e,f,g,h,i,b=this;this.dom.folderTree,d=this.dom.fileList,e=a.dialog,f=a.url,g=a.data,e.content('<div class="loading">正在提交并保存数据，请稍候...</div>').padding("20px").button({id:"ok",remove:!0},{id:"cancel",disabled:!0}),Admin.ajax({me:"",async:!1,url:f,data:g,success:function(){var a;for(h=Admin.ajaxData.auxJson[0],e.success("删除成功").button({id:"cancel",remove:!0}).shadow(!1).timeout(2),a=0;a<h.folders.length;a++)"true"==h.folders[a].delete_result&&(b.treeFolderRemove(h.folders[a].folderpath),i=d.find(".folder[folderpath='"+h.folders[a].folderpath+"']"),i.delayRemove(100));for(a=0;a<h.files.length;a++)"true"==h.files[a].delete_result&&(i=d.find(".file[filepath='"+h.files[a].filepath+"']"),i.delayRemove(100))},failed:function(a){e.error("删除失败",a).button({id:"cancel",okVal:"关闭",focus:!0}).timeout(2)}})},fileRename:function(a){var b=this,c=a.me,d=OWDialog({id:OW.createDialogID(),title:"文件重命名",content:FILEMANAGE.fileRenameTpl.replace("{tpl:filename}",OW.filename(c.attr("filepath"))),padding:"0px",ok:function(){var a=$("input[name='new_filename']"),e=$.trim(a.val()),f=c.attr("filepath"),g=!0;return V.input({me:a,tip:$("span[name='t_new_filename']"),errorValue:"请先填写新文件名！"})||(g=!1),g&&(d.content('<div class="loading">正在提交保存，请稍候...</div>').padding("20px").button({id:"ok",remove:!0},{id:"cancel",remove:!0}),Admin.ajax({me:"",async:!1,url:"index.asp?ctl="+b.config.ctl+"&act=edit_filerename"+b.config.auxUrlPara,data:"new_filename="+escape(e)+"&filepath="+f,success:function(){d.title(!1).success("成功修改文件名").shadow(!1).timeout(2),b.folderAndFilesReload({folderpath:b.dom.dirPath.attr("folderpath")})},failed:function(a){d.title(!1).error("文件名重命名失败",a).shadow(!1).timeout(2)}})),!1},cancel:!0,close:!1})},rebackSelectFile:function(){var a=this;a.dom.fileList}},FILEMANAGE.fn.constructor.prototype=FILEMANAGE.fn,FILEMANAGE.defaults={listType:"list",auxUrlPara:""},FILEMANAGE.createFolderTpl='<dl class="create-new-folder"><dt>文件夹名称</dt><dd><input type="text" class="text" name="new_folder_name" maxlength="50" onblur=OW.onblur(this,{rep:"/[^0-9a-zA-Z_-]*/g",length:50}) /><br><span class="t-normal" name="t_new_folder_name"></span></dd></dl>',FILEMANAGE.fileRenameTpl='<dl class="file-rename"><dt>原文件名: {tpl:filename}</dt><dd>新文件名</dd><dd><input type="text" class="text" name="new_filename" maxlength="50" onblur=OW.onblur(this,{rep:"/[^0-9a-zA-Z._-]*/g",length:50}) /><br><span class="t-normal" name="t_new_filename"></span></dd></dl>',OWFileManage=FILEMANAGE};OWFileManage_Class(this.jQuery,this);